{% block modal %}
<div class="modal" id="reg-form">
    <div class="container figma-glass light auth">
        <div class="auth-header">
            <img src="../../static/images/LOGO.svg" alt="">
            <h3 class="auth-title">Регистрация</h3>
        </div>

        <form method="post" class="auth-form" id="registerForm" action="{{ url_for('buyer.register') }}">
            <!-- Личная информация -->
                <div class="input-group">
                    <input name="full_name"  placeholder="ФИО контактного лица" required class="form-input" id="fullName">
                </div>

            <!-- Корпоративная информация -->
                <!-- ИНН -->
                <div class="input-group">
                    <div class="input-wrapper">
                    <input name="inn" placeholder="ИНН компании" required class="form-input" id="inn" maxlength="12" pattern="\d{10,12}">
                    <button type="button" class="form-input-button" id="verifyInn" title="Проверить ИНН">
                        <i class="fas fa-search"></i>
                    </button>
                    </div>
                    <div class="input-hint">10 цифр для юрлиц, 12 для ИП</div>
                    <div class="inn-status" id="innStatus"></div>
                </div>

                <!-- Email -->
                <div class="input-group">
                    <div class="input-wrapper">
                    <input name="email" type="email" placeholder="Корпоративная почта" required class="form-input" id="email">
                    </div>
                    <div class="input-hint">Только корпоративные домены организации</div>
                </div>

                <!-- Телефон -->
                <div class="input-group">
                    <div class="input-wrapper">
                    <input name="phone" type="tel" placeholder="Контактный номер телефона" required class="form-input" id="phone">
                    </div>
                    <div class="input-hint">Формат: +7 (XXX) XXX-XX-XX</div>
                </div>

            <!-- Безопасность -->

                <!-- Пароль -->
                <div class="input-group">
                    <div class="input-wrapper">
                    <input name="password" placeholder="Создайте пароль" type="password" required class="form-input" id="password">
                    <button type="button" class="form-input-button" id="togglePassword">
                        <i class="fas fa-eye"></i>
                    </button>
                    </div>
                    <div class="password-strength" id="passwordStrength">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <div class="strength-text" id="strengthText">Введите пароль</div>
                    </div>
                    <div class="password-requirements" id="passwordRequirements">
                        <div class="requirement" id="reqLength">✓ Минимум 8 символов</div>
                        <div class="requirement" id="reqUpper">✓ Заглавная буква</div>
                        <div class="requirement" id="reqLower">✓ Строчная буква</div>
                        <div class="requirement" id="reqNumber">✓ Цифра</div>
                        <div class="requirement" id="reqSpecial">✓ Спецсимвол</div>
                    </div>
                </div>

                <!-- Подтверждение пароля -->
                <div class="input-group">
                    
                    <div class="input-wrapper">
                    <input name="confirm_password" placeholder="Подтвердите пароль" type="password" required class="form-input" id="confirmPassword">
                    <button type="button" class="form-input-button" id="toggleConfirmPassword">
                        <i class="fas fa-eye"></i>
                    </button>
                    </div>
                    <div class="input-hint" id="confirmHint">Пароли должны совпадать</div>
                </div>

            <div class="terms-group">
                <label class="checkbox-label">
                    <input type="checkbox" required class="form-check-input" id="termsCheckbox">
                    Я подтверждаю, что являюсь уполномоченным представителем компании и принимаю
                    <a href="#" class="auth-link">договор оферты</a> и
                    <a href="#" class="auth-link">политику конфиденциальности</a>
                </label>
            </div>

            <button type="submit" class="btn-auth btn-register" id="submitBtn" disabled>
                Зарегистрировать
            </button>
        </form>

        <div class="register-footer">
            <p class="login-link">Уже есть корпоративный аккаунт? <a href="{{ url_for('buyer.login') }}" class="auth-link">Войти</a></p>
        </div>
    </div>
</div>

<style>
.inn-status {
    font-size: 12px;
    margin-top: 5px;
    padding: 4px 8px;
    border-radius: 4px;
    display: none;
}

.inn-status.verified {
    display: block;
    color: #ffffff;
    border: 1px solid #9ae6b4;
}

.inn-status.error {
    display: block;
    background: #fed7d7;
    color: #742a2a;
    border: 1px solid #feb2b2;
}

.inn-status.loading {
    display: block;
    color: #ffffff;
    border: 1px solid #90cdf4;
}

</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirmPassword');
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const passwordStrength = document.getElementById('passwordStrength');
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    const passwordRequirements = document.getElementById('passwordRequirements');
    const submitBtn = document.getElementById('submitBtn');
    const termsCheckbox = document.getElementById('termsCheckbox');

    // Элементы требований к паролю
    const reqLength = document.getElementById('reqLength');
    const reqUpper = document.getElementById('reqUpper');
    const reqLower = document.getElementById('reqLower');
    const reqNumber = document.getElementById('reqNumber');
    const reqSpecial = document.getElementById('reqSpecial');
    const confirmHint = document.getElementById('confirmHint');

    // Функция переключения видимости пароля
    function togglePasswordVisibility(input, button) {
        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);

        // Обновляем иконку
        const icon = button.querySelector('i');
        if (type === 'text') {
            icon.className = 'fas fa-eye-slash';
            button.title = 'Скрыть пароль';
        } else {
            icon.className = 'fas fa-eye';
            button.title = 'Показать пароль';
        }
    }

    // Обработчики для кнопок просмотра пароля
    togglePassword.addEventListener('click', function() {
        togglePasswordVisibility(passwordInput, this);
    });

    toggleConfirmPassword.addEventListener('click', function() {
        togglePasswordVisibility(confirmInput, this);
    });

    function checkPasswordStrength(password) {
        let strength = 0;
        const requirements = {
            length: password.length >= 8,
            upper: /[A-Z]/.test(password),
            lower: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };

        // Обновляем отображение требований
        reqLength.classList.toggle('met', requirements.length);
        reqUpper.classList.toggle('met', requirements.upper);
        reqLower.classList.toggle('met', requirements.lower);
        reqNumber.classList.toggle('met', requirements.number);
        reqSpecial.classList.toggle('met', requirements.special);

        // Подсчет силы
        if (requirements.length) strength++;
        if (requirements.upper) strength++;
        if (requirements.lower) strength++;
        if (requirements.number) strength++;
        if (requirements.special) strength++;

        // Обновляем индикатор силы
        if (password.length === 0) {
            passwordStrength.classList.remove('show');
            passwordRequirements.classList.remove('show');
            strengthFill.className = 'strength-fill';
            strengthText.textContent = 'Введите пароль';
        } else {
            passwordStrength.classList.add('show');
            passwordRequirements.classList.add('show');

            if (strength <= 1) {
                strengthFill.className = 'strength-fill weak';
                strengthText.textContent = 'Слабый';
                strengthText.style.color = '#e53e3e';
            } else if (strength <= 2) {
                strengthFill.className = 'strength-fill fair';
                strengthText.textContent = 'Средний';
                strengthText.style.color = '#dd6b20';
            } else if (strength <= 3) {
                strengthFill.className = 'strength-fill good';
                strengthText.textContent = 'Хороший';
                strengthText.style.color = '#d69e2e';
            } else {
                strengthFill.className = 'strength-fill strong';
                strengthText.textContent = 'Надежный';
                strengthText.style.color = '#38a169';
            }
        }

        return strength >= 3; // Минимум 3 из 5 требований
    }

    function checkPasswordMatch() {
        const password = passwordInput.value;
        const confirm = confirmInput.value;

        if (confirm.length === 0) {
            confirmHint.textContent = 'Пароли должны совпадать';
            confirmHint.style.color = '#718096';
            return false;
        } else if (password === confirm) {
            confirmHint.textContent = 'Пароли совпадают';
            confirmHint.style.color = '#38a169';
            return true;
        } else {
            confirmHint.textContent = 'Пароли не совпадают';
            confirmHint.style.color = '#e53e3e';
            return false;
        }
    }

    function validateForm() {
        const isPasswordStrong = checkPasswordStrength(passwordInput.value);
        const isPasswordMatch = checkPasswordMatch();
        const isTermsAccepted = termsCheckbox.checked;

        // Проверяем, что все поля заполнены
        const fullName = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();

        const allFieldsFilled = fullName && email && phone && passwordInput.value && confirmInput.value;

        submitBtn.disabled = !(isPasswordStrong && isPasswordMatch && isTermsAccepted && allFieldsFilled);
    }

    // Слушатели событий
    passwordInput.addEventListener('input', validateForm);
    confirmInput.addEventListener('input', validateForm);
    termsCheckbox.addEventListener('change', validateForm);

    // Слушатели для всех полей формы
    const formInputs = document.querySelectorAll('.form-input, .checkbox-input');
    formInputs.forEach(input => {
        input.addEventListener('input', validateForm);
        input.addEventListener('change', validateForm);
    });

    // Инициализация
    validateForm();
});

// Обработка отправки формы регистрации
// Обработка отправки формы регистрации
// Обработка отправки формы регистрации
document.addEventListener('DOMContentLoaded', function() {
    const registerForm = document.getElementById('registerForm');
    
    if (registerForm) {
        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Регистрация...';
            
            const formData = new FormData(registerForm);
            
            // Создаем AbortController для контроля таймаута
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 секунд таймаут
            
            fetch(registerForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Успешная регистрация
                    console.log('Регистрация успешна:', data.message);
                    
                    // Закрываем модальное окно
                    const modal = document.getElementById('reg-form');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                    
                    // Очищаем форму
                    registerForm.reset();
                    
                } else {
                    // Ошибки
                    console.log('Ошибки регистрации:', data.errors);
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    console.error('Таймаут запроса');
                } else {
                    console.error('Ошибка:', error);
                }
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }


    
    // Обработчик для закрытия модального окна при клике вне его
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('reg-form');
        if (modal && modal.style.display === 'flex' && event.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // Закрытие по ESC
    document.addEventListener('keydown', function(event) {
        const modal = document.getElementById('reg-form');
        if (modal && modal.style.display === 'flex' && event.key === 'Escape') {
            modal.style.display = 'none';
        }
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const innInput = document.getElementById('inn');
    const verifyInnBtn = document.getElementById('verifyInn');
    const innStatus = document.getElementById('innStatus');
    const fullNameInput = document.getElementById('fullName');

    // Функция проверки ИНН через наш сервер
    async function verifyInn() {
        const inn = innInput.value.trim();

        if (!inn || inn.length < 10) {
            showInnStatus('Введите корректный ИНН (10-12 цифр)', 'error');
            return;
        }

        // Базовая валидация формата
        if (!/^\d{10,12}$/.test(inn)) {
            showInnStatus('ИНН должен содержать только цифры', 'error');
            return;
        }

        showInnStatus('Проверяем ИНН...', 'loading');
        verifyInnBtn.disabled = true;

        try {
            const response = await fetch('/verify_inn', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ inn: inn })
            });

            const data = await response.json();

            if (data.success) {
                // Автозаполнение данных компании
                if (data.company_name) {
                    showInnStatus(`✓ ${data.company_name}`, 'verified');
                } else {
                    showInnStatus('✓ ИНН проверен', 'verified');
                }

                // Можно добавить автозаполнение других полей при необходимости
                // if (data.full_name && !fullNameInput.value) {
                //     fullNameInput.value = data.full_name;
                // }
            } else {
                showInnStatus(data.error || 'Ошибка проверки ИНН', 'error');
            }
        } catch (error) {
            console.error('Ошибка проверки ИНН:', error);
            showInnStatus('Ошибка подключения. Проверьте ИНН вручную', 'error');
        } finally {
            verifyInnBtn.disabled = false;
        }
    }

    function showInnStatus(message, type) {
        innStatus.textContent = message;
        innStatus.className = `inn-status ${type}`;
    }

    // Валидация ИНН на клиенте
    function validateInn(inn) {
        if (!inn) return false;

        inn = inn.trim();
        if (!/^\d+$/.test(inn)) return false;

        if (inn.length === 10) {
            // Валидация ИНН юридического лица
            const coefficients = [2, 4, 10, 3, 5, 9, 4, 6, 8];
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                sum += parseInt(inn[i]) * coefficients[i];
            }
            const control = (sum % 11) % 10;
            return control === parseInt(inn[9]);
        } else if (inn.length === 12) {
            // Валидация ИНН индивидуального предпринимателя
            const coefficients1 = [7, 2, 4, 10, 3, 5, 9, 4, 6, 8];
            const coefficients2 = [3, 7, 2, 4, 10, 3, 5, 9, 4, 6, 8];

            let sum1 = 0, sum2 = 0;
            for (let i = 0; i < 10; i++) {
                sum1 += parseInt(inn[i]) * coefficients1[i];
            }
            for (let i = 0; i < 11; i++) {
                sum2 += parseInt(inn[i]) * coefficients2[i];
            }

            const control1 = (sum1 % 11) % 10;
            const control2 = (sum2 % 11) % 10;

            return control1 === parseInt(inn[10]) && control2 === parseInt(inn[11]);
        }

        return false;
    }

    // События для ИНН
    verifyInnBtn.addEventListener('click', verifyInn);

    innInput.addEventListener('input', function() {
        innStatus.className = 'inn-status';
        validateForm();

        // Автоматическая проверка при вводе 10 или 12 цифр
        const inn = this.value.trim();
        if ((inn.length === 10 || inn.length === 12) && /^\d+$/.test(inn)) {
            verifyInn();
        }
    });

    // Обновляем validateForm чтобы включать проверку ИНН
    const originalValidateForm = validateForm;
    window.validateForm = function() {
        const isValid = originalValidateForm();
        const inn = innInput.value.trim();

        // Проверяем ИНН
        const isInnValid = validateInn(inn);
        if (inn && !isInnValid) {
            showInnStatus('Неверный формат ИНН', 'error');
        }

        // Дополнительная проверка для кнопки отправки
        const fullName = fullNameInput.value.trim();

        submitBtn.disabled = !(isValid && isInnValid && fullName);

        return isValid && isInnValid;
    };

    // Остальной существующий код...
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirmPassword');
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const passwordStrength = document.getElementById('passwordStrength');
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    const passwordRequirements = document.getElementById('passwordRequirements');
    const submitBtn = document.getElementById('submitBtn');
    const termsCheckbox = document.getElementById('termsCheckbox');

    // Элементы требований к паролю
    const reqLength = document.getElementById('reqLength');
    const reqUpper = document.getElementById('reqUpper');
    const reqLower = document.getElementById('reqLower');
    const reqNumber = document.getElementById('reqNumber');
    const reqSpecial = document.getElementById('reqSpecial');
    const confirmHint = document.getElementById('confirmHint');

    // Функция переключения видимости пароля
    function togglePasswordVisibility(input, button) {
        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);

        // Обновляем иконку
        const icon = button.querySelector('i');
        if (type === 'text') {
            icon.className = 'fas fa-eye-slash';
            button.title = 'Скрыть пароль';
        } else {
            icon.className = 'fas fa-eye';
            button.title = 'Показать пароль';
        }
    }

    // Обработчики для кнопок просмотра пароля
    togglePassword.addEventListener('click', function() {
        togglePasswordVisibility(passwordInput, this);
    });

    toggleConfirmPassword.addEventListener('click', function() {
        togglePasswordVisibility(confirmInput, this);
    });

    function checkPasswordStrength(password) {
        let strength = 0;
        const requirements = {
            length: password.length >= 8,
            upper: /[A-Z]/.test(password),
            lower: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };

        // Обновляем отображение требований
        reqLength.classList.toggle('met', requirements.length);
        reqUpper.classList.toggle('met', requirements.upper);
        reqLower.classList.toggle('met', requirements.lower);
        reqNumber.classList.toggle('met', requirements.number);
        reqSpecial.classList.toggle('met', requirements.special);

        // Подсчет силы
        if (requirements.length) strength++;
        if (requirements.upper) strength++;
        if (requirements.lower) strength++;
        if (requirements.number) strength++;
        if (requirements.special) strength++;

        // Обновляем индикатор силы
        if (password.length === 0) {
            passwordStrength.classList.remove('show');
            passwordRequirements.classList.remove('show');
            strengthFill.className = 'strength-fill';
            strengthText.textContent = 'Введите пароль';
        } else {
            passwordStrength.classList.add('show');
            passwordRequirements.classList.add('show');

            if (strength <= 1) {
                strengthFill.className = 'strength-fill weak';
                strengthText.textContent = 'Слабый';
                strengthText.style.color = '#e53e3e';
            } else if (strength <= 2) {
                strengthFill.className = 'strength-fill fair';
                strengthText.textContent = 'Средний';
                strengthText.style.color = '#dd6b20';
            } else if (strength <= 3) {
                strengthFill.className = 'strength-fill good';
                strengthText.textContent = 'Хороший';
                strengthText.style.color = '#d69e2e';
            } else {
                strengthFill.className = 'strength-fill strong';
                strengthText.textContent = 'Надежный';
                strengthText.style.color = '#38a169';
            }
        }

        return strength >= 3; // Минимум 3 из 5 требований
    }

    function checkPasswordMatch() {
        const password = passwordInput.value;
        const confirm = confirmInput.value;

        if (confirm.length === 0) {
            confirmHint.textContent = 'Пароли должны совпадать';
            confirmHint.style.color = '#718096';
            return false;
        } else if (password === confirm) {
            confirmHint.textContent = 'Пароли совпадают';
            confirmHint.style.color = '#38a169';
            return true;
        } else {
            confirmHint.textContent = 'Пароли не совпадают';
            confirmHint.style.color = '#e53e3e';
            return false;
        }
    }
    // Инициализация
    validateForm();
});
</script>
{% endblock %}