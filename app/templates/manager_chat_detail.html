{% extends "base.html" %}

{% block content %}
<style>
    :root {
        --manager-primary: #2980b9;
        --manager-secondary: #3498db;
        --manager-accent: #e67e22;
        --manager-success: #27ae60;
        --manager-warning: #f39c12;
        --manager-danger: #e74c3c;
        --manager-info: #3498db;
        --manager-light: #ecf0f1;
        --manager-dark: #2c3e50;
        --user-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --bot-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --manager-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    body {
        background:
            radial-gradient(circle at 0% 0%, rgba(41, 128, 185, 0.08) 0%, transparent 50%),
            radial-gradient(circle at 100% 100%, rgba(230, 126, 34, 0.06) 0%, transparent 50%),
            radial-gradient(circle at 50% 50%, rgba(52, 152, 219, 0.04) 0%, transparent 70%),
            linear-gradient(135deg, #f8fafc 0%, #e9ecef 50%, #f8fafc 100%);

        min-height: 100vh;
    }

    .chat-detail-container {
        max-width: 1400px;
        margin: 0 auto;
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        padding: 2rem;
        gap: 1.5rem;
        position: relative;
    }

    .chat-detail-container::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background:
            radial-gradient(circle at 20% 20%, rgba(41, 128, 185, 0.05) 0%, transparent 40%),
            radial-gradient(circle at 80% 80%, rgba(230, 126, 34, 0.04) 0%, transparent 40%);
        animation: cosmicFloat 25s ease-in-out infinite;
        z-index: -1;
    }

    @keyframes cosmicFloat {
        0%, 100% { transform: translate(0, 0) rotate(0deg) scale(1); }
        25% { transform: translate(20px, -20px) rotate(1deg) scale(1.02); }
        50% { transform: translate(-15px, 15px) rotate(-1deg) scale(0.98); }
        75% { transform: translate(10px, 10px) rotate(0.5deg) scale(1.01); }
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ - –ø–æ–ª–Ω—ã–π —Ä–µ–¥–∏–∑–∞–π–Ω */
    .chat-header {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 249, 250, 0.98));
        padding: 1.75rem 2rem;
        border-radius: 25px;
        box-shadow:
            0 20px 50px rgba(0, 0, 0, 0.12),
            0 8px 25px rgba(41, 128, 185, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .chat-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--manager-primary), var(--manager-accent), var(--manager-info));
        background-size: 200% 100%;
        animation: headerShimmer 4s ease-in-out infinite;
    }

    .chat-header::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        transition: left 0.8s ease;
    }

    .chat-header:hover::after {
        left: 100%;
    }


    @keyframes headerShimmer {
        0%, 100% { background-position: -200% 0; }
        50% { background-position: 200% 0; }
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .back-btn {
        background: linear-gradient(135deg, var(--manager-dark), #34495e);
        color: white;
        border: none;
        border-radius: 15px;
        padding: 0.75rem 1.25rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(44, 62, 80, 0.3);
        position: relative;
        overflow: hidden;
    }

    .back-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .back-btn:hover::before {
        left: 100%;
    }

    .back-btn:hover {
        transform: translateX(-3px);
        box-shadow: 0 8px 25px rgba(44, 62, 80, 0.4);
    }

    .user-avatar {
        width: 70px;
        height: 70px;
        border-radius: 22px;
        background: linear-gradient(135deg, var(--manager-primary), var(--manager-secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 800;
        font-size: 1.8rem;
        box-shadow:
            0 12px 30px rgba(41, 128, 185, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.3),
            0 0 0 4px rgba(255, 255, 255, 0.8);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
    }

    .user-avatar::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.15), transparent);
        transform: rotate(45deg);
        transition: all 0.6s ease;
    }

    .chat-header:hover .user-avatar {
        transform: scale(1.08) rotate(3deg);
        box-shadow:
            0 16px 40px rgba(41, 128, 185, 0.5),
            inset 0 1px 0 rgba(255, 255, 255, 0.4),
            0 0 0 4px rgba(255, 255, 255, 0.9);
    }

    .chat-header:hover .user-avatar::before {
        transform: rotate(45deg) translate(30%, 30%);
    }

    .user-details h4 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--manager-dark), var(--manager-primary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 4px 15px rgba(41, 128, 185, 0.2);
    }

    .user-details .text-muted {
        color: #7f8c8d;
        font-size: 1rem;
        font-weight: 600;
        background: rgba(127, 140, 141, 0.1);
        padding: 0.4rem 1rem;
        border-radius: 15px;
        display: inline-block;
        backdrop-filter: blur(10px);
    }

    .chat-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .bot-toggle {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        border-radius: 20px;
        cursor: pointer;
        user-select: none;
        font-weight: 700;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }

    .bot-toggle::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.6s ease;
    }

    .bot-toggle:hover::before {
        left: 100%;
    }

    .bot-toggle.active {
        background: linear-gradient(135deg, var(--manager-success), #2ecc71);
        color: white;
        box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        border-color: rgba(255, 255, 255, 0.3);
    }

    .bot-toggle:not(.active) {
        background: linear-gradient(135deg, var(--manager-danger), #c0392b);
        color: white;
        box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        border-color: rgba(255, 255, 255, 0.3);
    }

    .bot-toggle:hover {
        transform: translateY(-2px) scale(1.05);
    }

    /* –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π - –ø–æ–ª–Ω—ã–π —Ä–µ–¥–∏–∑–∞–π–Ω */
    .chat-messages {
        flex: 1;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(248, 249, 250, 0.95));
        border-radius: 25px;
        padding: 2rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        border: 1px solid rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        box-shadow:
            0 20px 50px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        position: relative;
    }

    .chat-messages::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
            radial-gradient(circle at 10% 20%, rgba(41, 128, 185, 0.03) 0%, transparent 30%),
            radial-gradient(circle at 90% 80%, rgba(230, 126, 34, 0.02) 0%, transparent 30%);
        pointer-events: none;
        border-radius: 25px;
    }

    /* –û–±–µ—Ä—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
    .message-wrapper {
        display: flex;
        max-width: 75%;
        animation: messageAppear 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }

    @keyframes messageAppear {
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–ø—Ä–∞–≤–∞) */
    .user-message {
        margin-left: auto;
    }

    /* –°–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (—Å–ª–µ–≤–∞) */
    .other-message {
        margin-right: auto;
    }

    /* –ë–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å –ø—É–∑—ã—Ä—è —Å–æ–æ–±—â–µ–Ω–∏—è */
    .message-bubble {
        display: flex;
        gap: 1rem;
        padding: 1.5rem;
        border-radius: 25px;
        box-shadow:
            0 8px 30px rgba(0, 0, 0, 0.12),
            0 4px 15px rgba(0, 0, 0, 0.08);
        position: relative;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        max-width: 100%;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.6);
    }

    .message-bubble::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 25px;
        padding: 2px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.1));
        -webkit-mask:
            linear-gradient(#fff 0 0) content-box,
            linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .message-bubble:hover::before {
        opacity: 1;
    }

    .message-bubble:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow:
            0 15px 40px rgba(0, 0, 0, 0.18),
            0 8px 25px rgba(0, 0, 0, 0.12);
    }

    /* –ê–≤–∞—Ç–∞—Ä—ã */
    .avatar {
        width: 50px;
        height: 50px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
        border: 3px solid rgba(255, 255, 255, 0.9);
        box-shadow:
            0 6px 20px rgba(0, 0, 0, 0.2),
            0 0 0 2px rgba(255, 255, 255, 0.8);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .avatar::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transform: rotate(45deg);
        transition: all 0.6s ease;
    }

    .message-bubble:hover .avatar {
        transform: scale(1.1) rotate(5deg);
        box-shadow:
            0 8px 25px rgba(0, 0, 0, 0.25),
            0 0 0 2px rgba(255, 255, 255, 0.9);
    }

    .message-bubble:hover .avatar::before {
        transform: rotate(45deg) translate(20%, 20%);
    }

    .user-avatar {
        background: var(--user-gradient);
        color: white;
    }

    .bot-avatar {
        background: var(--bot-gradient);
        color: white;
    }

    .manager-avatar {
        background: var(--manager-gradient);
        color: white;
    }

    /* –ö–æ–Ω—Ç–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è */
    .message-content {
        flex: 1;
        min-width: 0;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è */
    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .sender-name {
        font-weight: 700;
        font-size: 0.95rem;
        background: linear-gradient(135deg, var(--manager-dark), var(--manager-primary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .message-time {
        font-size: 0.8rem;
        color: #7f8c8d;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-left: 1rem;
        font-weight: 600;
    }

    /* –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è */
    .message-text {
        line-height: 1.6;
        color: #2c3e50;
        word-wrap: break-word;
        font-size: 0.95rem;
        font-weight: 500;
    }

    /* –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è */
    .message-status {
        text-align: right;
        margin-top: 0.75rem;
    }

    .delivered {
        color: var(--manager-success);
        font-size: 0.8rem;
        font-weight: 700;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π */
    .user-bubble {
        background: linear-gradient(145deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.9));
        color: white;
        border-bottom-right-radius: 8px;
    }

    .user-bubble .sender-name,
    .user-bubble .message-time,
    .user-bubble .message-text {
        color: white;
    }

    .user-bubble .message-time {
        opacity: 0.9;
    }

    .bot-bubble {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 249, 250, 0.9));
        border: 1px solid rgba(233, 236, 239, 0.8);
        border-bottom-left-radius: 8px;
    }

    .manager-bubble {
        background: linear-gradient(145deg, rgba(227, 242, 253, 0.95), rgba(187, 222, 251, 0.9));
        border: 1px solid rgba(144, 202, 249, 0.6);
        border-bottom-left-radius: 8px;
    }

    /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç */
    .date-divider {
        text-align: center;
        margin: 2rem 0;
        position: relative;
    }

    .date-divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, transparent 0%, rgba(41, 128, 185, 0.3) 50%, transparent 100%);
    }

    .date-text {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 249, 250, 0.9));
        padding: 0.75rem 1.5rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--manager-primary);
        border: 1px solid rgba(255, 255, 255, 0.8);
        box-shadow:
            0 8px 25px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        display: inline-block;
        position: relative;
        z-index: 1;
        backdrop-filter: blur(10px);
    }

    /* –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ —á–∞—Ç–∞ */
    .empty-chat-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
        position: relative;
    }

    .empty-chat-icon {
        font-size: 5rem;
        margin-bottom: 1.5rem;
        background: linear-gradient(135deg, var(--manager-primary), var(--manager-accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        opacity: 0.7;
    }

    .empty-chat-state h4 {
        margin-bottom: 1rem;
        color: var(--manager-dark);
        font-weight: 700;
        font-size: 1.5rem;
    }

    .empty-chat-state p {
        font-size: 1rem;
        opacity: 0.8;
        line-height: 1.6;
    }

    /* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
    .chat-input-form {
        display: flex;
        gap: 1rem;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 249, 250, 0.98));
        padding: 1.5rem 2rem;
        border-radius: 25px;
        box-shadow:
            0 20px 50px rgba(0, 0, 0, 0.12),
            0 8px 25px rgba(41, 128, 185, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        position: relative;
        overflow: hidden;
    }

    .chat-input-form::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--manager-primary), var(--manager-accent), var(--manager-info));
        background-size: 200% 100%;
        animation: inputShimmer 4s ease-in-out infinite;
    }

    .message-input {
        flex: 1;
        padding: 1.25rem 1.5rem;
        border: 2px solid rgba(233, 236, 239, 0.8);
        border-radius: 20px;
        resize: none;
        height: 70px;
        font-size: 1rem;
        font-weight: 500;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        box-shadow:
            inset 0 2px 10px rgba(0, 0, 0, 0.05),
            0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .message-input:focus {
        outline: none;
        border-color: var(--manager-primary);
        background: rgba(255, 255, 255, 0.95);
        box-shadow:
            inset 0 2px 15px rgba(41, 128, 185, 0.1),
            0 0 0 3px rgba(41, 128, 185, 0.1),
            0 1px 0 rgba(255, 255, 255, 0.8);
        transform: translateY(-1px);
    }

    .send-btn {
        background: linear-gradient(135deg, var(--manager-primary), var(--manager-secondary));
        color: white;
        border: none;
        border-radius: 20px;
        padding: 0 2.5rem;
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow:
            0 8px 25px rgba(41, 128, 185, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
        position: relative;
        overflow: hidden;
    }

    .send-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.6s ease;
    }

    .send-btn:hover::before {
        left: 100%;
    }

    .send-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow:
            0 12px 35px rgba(41, 128, 185, 0.5),
            inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }

    .send-btn:active {
        transform: translateY(-1px) scale(1.02);
    }

    @keyframes inputShimmer {
        0%, 100% { background-position: -200% 0; }
        50% { background-position: 200% 0; }
    }

    /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
    .chat-messages::-webkit-scrollbar {
        width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: rgba(236, 240, 241, 0.5);
        border-radius: 10px;
        margin: 10px 0;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, var(--manager-primary), var(--manager-accent));
        border-radius: 10px;
        border: 2px solid rgba(255, 255, 255, 0.8);
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, var(--manager-secondary), var(--manager-warning));
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .chat-detail-container {
            padding: 1rem;
            height: calc(100vh - 60px);
        }

        .message-wrapper {
            max-width: 90%;
        }

        .message-bubble {
            padding: 1.25rem;
            gap: 0.75rem;
        }

        .avatar {
            width: 42px;
            height: 42px;
            font-size: 1rem;
        }

        .chat-messages {
            padding: 1.5rem;
        }

        .chat-header {
            padding: 1.25rem 1.5rem;
        }

        .user-avatar {
            width: 55px;
            height: 55px;
            font-size: 1.5rem;
        }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .new-message {
        animation: messageSlideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* –≠—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∏ */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem 1.5rem;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 20px;
        margin-bottom: 1rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .typing-dots {
        display: flex;
        gap: 0.25rem;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--manager-primary);
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1.2); opacity: 1; }
    }
</style>

<div class="chat-detail-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
    <div class="chat-header">
        <div class="user-info">
            <a href="{{ url_for('manager.chats') }}" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                –ù–∞–∑–∞–¥
            </a>
            <div class="user-avatar">
                {{ chat.user_name[0]|upper }}
            </div>
            <div>
                <h4 class="mb-1">{{ chat.user_name }}</h4>
                <div class="text-muted">üí¨ –ß–∞—Ç —Å –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º</div>
            </div>
        </div>
        <div class="chat-actions">
            <div class="bot-toggle {% if chat.bot_enabled %}active{% endif %}"
                 onclick="toggleBot('{{ chat.user_id }}', this)">
                <i class="fas fa-robot"></i>
                <span>{% if chat.bot_enabled %}–ë–æ—Ç –≤–∫–ª—é—á–µ–Ω{% else %}–ë–æ—Ç –≤—ã–∫–ª—é—á–µ–Ω{% endif %}</span>
            </div>
        </div>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="chat-messages" id="messagesContainer">
        {% if chat.messages %}
            {% for message in chat.messages %}
            <div class="message-wrapper {% if message.role == 'user' %}user-message{% else %}other-message{% endif %}"
                 data-timestamp="{{ message.timestamp }}">
                <div class="message-bubble {% if message.role == 'user' %}user-bubble{% elif message.role == 'bot' %}bot-bubble{% else %}manager-bubble{% endif %}">
                    <!-- –ê–≤–∞—Ç–∞—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                    <div class="message-avatar">
                        {% if message.role == 'user' %}
                            <div class="avatar user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                        {% elif message.role == 'bot' %}
                            <div class="avatar bot-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                        {% else %}
                            <div class="avatar manager-avatar">
                                <i class="fas fa-user-tie"></i>
                            </div>
                        {% endif %}
                    </div>

                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                    <div class="message-content">
                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–º–µ–Ω–µ–º –∏ –≤—Ä–µ–º–µ–Ω–µ–º -->
                        <div class="message-header">
                            <span class="sender-name">
                                {% if message.role == 'user' %}
                                    –ü–æ–∫—É–ø–∞—Ç–µ–ª—å
                                {% elif message.role == 'bot' %}
                                    AI –ü–æ–º–æ—â–Ω–∏–∫
                                {% else %}
                                    –ú–µ–Ω–µ–¥–∂–µ—Ä
                                {% endif %}
                            </span>
                            <span class="message-time">
                                <i class="fas fa-clock"></i>
                                {{ message.timestamp }}
                            </span>
                        </div>

                        <!-- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        <div class="message-text">
                            {{ message.content }}
                        </div>

                        <!-- –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è -->
                        <div class="message-status">
                            {% if message.role == 'user' %}
                                <i class="fas fa-check-double delivered"></i>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ —á–∞—Ç–∞ -->
            <div class="empty-chat-state">
                <div class="empty-chat-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <h4>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</h4>
                <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é –∏ –Ω–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</p>
            </div>
        {% endif %}
    </div>

    <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <form class="chat-input-form" id="messageForm">
        <textarea
            class="message-input"
            placeholder="üí≠ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
            id="messageInput"
            required></textarea>
        <button type="submit" class="send-btn">
            <i class="fas fa-paper-plane"></i>
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        </button>
    </form>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let isUserTyping = false;
let refreshInterval;
let lastMessageCount = {{ chat.messages|length if chat.messages else 0 }};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π –¥–∞—Ç –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π –¥–∞—Ç –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
function formatExistingMessages() {
    const messagesContainer = document.getElementById('messagesContainer');
    const messageWrappers = messagesContainer.querySelectorAll('.message-wrapper[data-timestamp]');

    if (messageWrappers.length === 0) return;

    let currentDate = null;
    const messagesArray = Array.from(messageWrappers);

    // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –¥–∞—Ç
    const existingDividers = messagesContainer.querySelectorAll('.date-divider');
    existingDividers.forEach(divider => divider.remove());

    // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
    messagesArray.forEach((wrapper, index) => {
        const timestamp = wrapper.getAttribute('data-timestamp');
        const timeElement = wrapper.querySelector('.message-time');

        if (timestamp && timeElement) {
            const messageDate = formatMessageDate(timestamp);
            const messageTime = formatMessageTime(timestamp);

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
            timeElement.innerHTML = `<i class="fas fa-clock"></i> ${messageTime}`;

            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç—ã
            if (messageDate !== currentDate) {
                currentDate = messageDate;

                const dateDivider = document.createElement('div');
                dateDivider.className = 'date-divider';
                dateDivider.innerHTML = `<span class="date-text">${messageDate}</span>`;

                // –í—Å—Ç–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–µ—Ä–µ–¥ —Ç–µ–∫—É—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                if (index === 0) {
                    messagesContainer.insertBefore(dateDivider, wrapper);
                } else {
                    messagesContainer.insertBefore(dateDivider, wrapper);
                }
            }
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏—è
function formatMessageDate(timestamp) {
    const date = new Date(timestamp);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    if (date.toDateString() === today.toDateString()) {
        return '–°–µ–≥–æ–¥–Ω—è';
    } else if (date.toDateString() === yesterday.toDateString()) {
        return '–í—á–µ—Ä–∞';
    } else {
        return date.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
function formatMessageTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞
async function toggleBot(userId, element) {
    try {
        const response = await fetch(`/manager/toggle_bot/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (response.ok) {
            const result = await response.json();
            element.classList.toggle('active');

            const span = element.querySelector('span');
            const icon = element.querySelector('i');

            if (result.bot_enabled) {
                span.innerHTML = 'ü§ñ –ë–æ—Ç –≤–∫–ª—é—á–µ–Ω';
                icon.className = 'fas fa-robot';
                showNotification('–ë–æ—Ç –≤–∫–ª—é—á–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞', 'success');
            } else {
                span.innerHTML = 'üö´ –ë–æ—Ç –≤—ã–∫–ª—é—á–µ–Ω';
                icon.className = 'fas fa-robot';
                showNotification('–ë–æ—Ç –≤—ã–∫–ª—é—á–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞', 'warning');
            }

            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
            element.style.transform = 'scale(1.1)';
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 150);

        } else {
            throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –±–æ—Ç–∞');
        }
    } catch (error) {
        console.error('Error toggling bot:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –±–æ—Ç–∞', 'error');
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage(event) {
    event.preventDefault();

    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();

    if (!message) return;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
    showTypingIndicator('manager');

    // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
    const sendBtn = document.querySelector('.send-btn');
    sendBtn.disabled = true;
    messageInput.disabled = true;

    try {
        const response = await fetch(`/manager/send_message/{{ chat.user_id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                role: 'manager'
            })
        });

        if (response.ok) {
            const result = await response.json();

            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            messageInput.value = '';

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
            addMessageToChat({
                content: message,
                role: 'manager',
                timestamp: new Date().toISOString()
            });

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            scrollToBottom();

        } else {
            throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
    } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
        sendBtn.disabled = false;
        messageInput.disabled = false;
        messageInput.focus();

        // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        hideTypingIndicator();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessageToChat(message) {
    const messagesContainer = document.getElementById('messagesContainer');

    // –£–±–∏—Ä–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ —á–∞—Ç–∞
    const emptyState = messagesContainer.querySelector('.empty-chat-state');
    if (emptyState) {
        emptyState.remove();
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
    const formattedTime = formatMessageTime(message.timestamp);
    const formattedDate = formatMessageDate(message.timestamp);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–µ–Ω –ª–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç—ã
    const lastMessage = messagesContainer.querySelector('.message-wrapper:last-child');
    let needsDateDivider = false;

    if (lastMessage) {
        const lastTimestamp = lastMessage.getAttribute('data-timestamp');
        const lastMessageDate = lastTimestamp ? formatMessageDate(lastTimestamp) : null;
        needsDateDivider = formattedDate !== lastMessageDate;
    } else {
        needsDateDivider = true;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (needsDateDivider) {
        const dateDivider = document.createElement('div');
        dateDivider.className = 'date-divider';
        dateDivider.innerHTML = `<span class="date-text">${formattedDate}</span>`;
        messagesContainer.appendChild(dateDivider);
    }

    // –°–æ–∑–¥–∞–µ–º wrapper —Å–æ–æ–±—â–µ–Ω–∏—è
    const messageWrapper = document.createElement('div');
    messageWrapper.className = `message-wrapper ${message.role === 'user' ? 'user-message' : 'other-message'} new-message`;
    messageWrapper.setAttribute('data-timestamp', message.timestamp);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –ø—É–∑—ã—Ä—è –∏ –∞–≤–∞—Ç–∞—Ä–∞
    let bubbleClass, avatarClass, avatarIcon, senderName;

    switch (message.role) {
        case 'user':
            bubbleClass = 'user-bubble';
            avatarClass = 'user-avatar';
            avatarIcon = 'fas fa-user';
            senderName = 'üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å';
            break;
        case 'bot':
            bubbleClass = 'bot-bubble';
            avatarClass = 'bot-avatar';
            avatarIcon = 'fas fa-robot';
            senderName = 'ü§ñ AI –ü–æ–º–æ—â–Ω–∏–∫';
            break;
        case 'manager':
            bubbleClass = 'manager-bubble';
            avatarClass = 'manager-avatar';
            avatarIcon = 'fas fa-user-tie';
            senderName = 'üíº –ú–µ–Ω–µ–¥–∂–µ—Ä';
            break;
    }

    // –°–æ–∑–¥–∞–µ–º HTML —Å–æ–æ–±—â–µ–Ω–∏—è
    messageWrapper.innerHTML = `
        <div class="message-bubble ${bubbleClass}">
            <div class="message-avatar">
                <div class="avatar ${avatarClass}">
                    <i class="${avatarIcon}"></i>
                </div>
            </div>
            <div class="message-content">
                <div class="message-header">
                    <span class="sender-name">${senderName}</span>
                    <span class="message-time">
                        <i class="fas fa-clock"></i>
                        ${formattedTime}
                    </span>
                </div>
                <div class="message-text">${message.content}</div>
                <div class="message-status">
                    ${message.role === 'user' ? '<i class="fas fa-check-double delivered"></i>' : ''}
                </div>
            </div>
        </div>
    `;

    messagesContainer.appendChild(messageWrapper);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(() => {
        messageWrapper.style.opacity = '1';
        messageWrapper.style.transform = 'translateY(0) scale(1)';
    }, 50);
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏
function showTypingIndicator(role) {
    const messagesContainer = document.getElementById('messagesContainer');

    // –£–±–∏—Ä–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    hideTypingIndicator();

    const typingDiv = document.createElement('div');
    typingDiv.className = 'message-wrapper other-message typing-indicator-wrapper';
    typingDiv.id = 'typingIndicator';

    let avatarClass, avatarIcon, senderName;

    if (role === 'bot') {
        avatarClass = 'bot-avatar';
        avatarIcon = 'fas fa-robot';
        senderName = 'ü§ñ AI –ü–æ–º–æ—â–Ω–∏–∫';
    } else {
        avatarClass = 'manager-avatar';
        avatarIcon = 'fas fa-user-tie';
        senderName = 'üíº –ú–µ–Ω–µ–¥–∂–µ—Ä';
    }

    typingDiv.innerHTML = `
        <div class="message-bubble bot-bubble">
            <div class="message-avatar">
                <div class="avatar ${avatarClass}">
                    <i class="${avatarIcon}"></i>
                </div>
            </div>
            <div class="message-content">
                <div class="message-header">
                    <span class="sender-name">${senderName}</span>
                </div>
                <div class="typing-indicator">
                    <span style="margin-right: 10px;">–ü–µ—á–∞—Ç–∞–µ—Ç</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>
    `;

    messagesContainer.appendChild(typingDiv);
    scrollToBottom();
}

// –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏
function hideTypingIndicator() {
    const existingIndicator = document.getElementById('typingIndicator');
    if (existingIndicator) {
        existingIndicator.remove();
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
function scrollToBottom() {
    const messagesContainer = document.getElementById('messagesContainer');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async function checkForNewMessages() {
    try {
        const response = await fetch(`/manager/get_messages/{{ chat.user_id }}?last_count=${lastMessageCount}`);

        if (response.ok) {
            const data = await response.json();

            if (data.messages && data.messages.length > lastMessageCount) {
                // –ï—Å—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                const newMessages = data.messages.slice(lastMessageCount);

                newMessages.forEach(message => {
                    addMessageToChat(message);
                });

                lastMessageCount = data.messages.length;
                scrollToBottom();

                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                playNotificationSound();
            }
        }
    } catch (error) {
        console.error('Error checking for new messages:', error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function playNotificationSound() {
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
    oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);

    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.2);
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${getNotificationIcon(type)}"></i>
            <span>${message}</span>
        </div>
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${getNotificationColor(type)};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        z-index: 10000;
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        max-width: 300px;
    `;

    document.body.appendChild(notification);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 100);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
    setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 400);
    }, 3000);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function getNotificationIcon(type) {
    const icons = {
        success: 'check-circle',
        error: 'exclamation-circle',
        warning: 'exclamation-triangle',
        info: 'info-circle'
    };
    return icons[type] || 'info-circle';
}

function getNotificationColor(type) {
    const colors = {
        success: 'linear-gradient(135deg, var(--manager-success), #2ecc71)',
        error: 'linear-gradient(135deg, var(--manager-danger), #c0392b)',
        warning: 'linear-gradient(135deg, var(--manager-warning), #f39c12)',
        info: 'linear-gradient(135deg, var(--manager-info), #3498db)'
    };
    return colors[type] || colors.info;
}

// –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∏ –≤—ã—Å–æ—Ç—ã —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
function autoResizeTextarea() {
    const textarea = document.getElementById('messageInput');
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    formatExistingMessages();

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    scrollToBottom();

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');

    messageForm.addEventListener('submit', sendMessage);
    messageInput.addEventListener('input', autoResizeTextarea);

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    refreshInterval = setInterval(checkForNewMessages, 3000);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –±—ã—Å—Ç—Ä–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ Enter (–±–µ–∑ Shift)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage(e);
        }
    });

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    const container = document.querySelector('.chat-detail-container');
    container.style.opacity = '0';
    container.style.transform = 'translateY(20px)';

    setTimeout(() => {
        container.style.transition = 'all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        container.style.opacity = '1';
        container.style.transform = 'translateY(0)';
    }, 100);
});

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ä–∞–∑–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>

<!-- –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<style>
.notification-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 600;
}

.notification-content i {
    font-size: 1.2rem;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.new-message {
    animation: messageSlideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}


/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 480px) {
    .chat-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }

    .user-info {
        flex-direction: column;
        gap: 1rem;
    }

    .chat-actions {
        justify-content: center;
    }

    .message-wrapper {
        max-width: 95%;
    }

    .message-bubble {
        flex-direction: column;
        text-align: center;
    }

    .message-header {
        flex-direction: column;
        gap: 0.5rem;
    }

}
</style>
{% endblock %}