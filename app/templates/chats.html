{% extends "base.html" %}

{% block content %}
<style>
    .chats-container {
        margin: 0 auto;
    }

    .chats-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }

    .chats-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .chats-header-content {
        position: relative;
        z-index: 2;
    }

    .chats-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    }

    .chat-card {
        background: white;
        border-radius: 16px;
        padding: 1.25rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        border: 1px solid rgba(255, 255, 255, 0.8);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .chat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
        background-size: 200% 100%;
        animation: gradientShift 3s ease infinite;
    }

    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .chat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    }

    .chat-card.unread {
        border-left: 4px solid #ff4757;
        background: linear-gradient(135deg, #fff9f9 0%, #fff5f5 100%);
    }

    .chat-card.manager-assigned {
        background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
        border-left: 4px solid #3498db;
    }

    .chat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        gap: 0.75rem;
    }

    .chat-user-info {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        flex: 1;
        min-width: 0;
    }

    .user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
        flex-shrink: 0;
    }

    .user-details {
        flex: 1;
        min-width: 0;
    }

    .user-details h4 {
        margin: 0 0 4px 0;
        color: #2c3e50;
        font-weight: 700;
        font-size: 1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .user-role {
        color: #7f8c8d;
        font-size: 0.8rem;
        margin-bottom: 6px;
    }

    .chat-status {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.4rem;
        flex-shrink: 0;
        min-width: fit-content;
    }

    .last-message-time {
        color: #95a5a6;
        font-size: 0.75rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 3px;
        white-space: nowrap;
    }

    .unread-badge {
        background: linear-gradient(135deg, #ff4757, #ff3742);
        color: white;
        padding: 0.35rem 0.7rem;
        border-radius: 16px;
        font-size: 0.7rem;
        font-weight: 700;
        box-shadow: 0 3px 8px rgba(255, 71, 87, 0.3);
        animation: pulse 2s infinite;
        white-space: nowrap;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .bot-status {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.7rem;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.4rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        white-space: nowrap;
    }

    .bot-enabled {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .bot-disabled {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .manager-info {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.7rem;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.4rem;
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        color: #1565c0;
        border: 1px solid #bbdefb;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        white-space: nowrap;
    }

    .last-message {
        color: #5d6d7e;
        font-size: 0.85rem;
        line-height: 1.4;
        margin-top: 0.8rem;
        padding: 0.8rem;
        background: rgba(0,0,0,0.02);
        border-radius: 10px;
        border-left: 3px solid #e9ecef;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .last-message strong {
        margin-right: 0.3rem;
    }

    .no-chats {
        text-align: center;
        padding: 3rem 1.5rem;
        color: #6c757d;
    }

    .no-chats-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #bdc3c7;
        opacity: 0.7;
    }

    .no-chats h3 {
        margin-bottom: 0.8rem;
        color: #495057;
        font-weight: 600;
        font-size: 1.3rem;
    }

    .no-chats p {
        font-size: 0.9rem;
        opacity: 0.8;
        line-height: 1.5;
    }

    .stats-badge {
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 0.8rem 1.2rem;
        text-align: center;
        border: 1px solid rgba(255,255,255,0.3);
    }

    .stats-number {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.2rem;
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .stats-label {
        font-size: 0.8rem;
        opacity: 0.9;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    .chat-card {
        animation: cardAppear 0.6s ease-out;
    }

    @keyframes cardAppear {
        from {
            opacity: 0;
            transform: translateY(15px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ===== –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ===== */

    /* –ü–ª–∞–Ω—à–µ—Ç—ã –∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –Ω–æ—É—Ç–±—É–∫–∏ */
    @media (max-width: 1024px) {
        .chats-container {
            padding: 12px;
        }

        .chats-grid {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 0.875rem;
        }

        .chat-card {
            padding: 1.125rem;
        }
    }

    /* –ü–ª–∞–Ω—à–µ—Ç—ã (–ø–æ—Ä—Ç—Ä–µ—Ç–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è) */
    @media (max-width: 768px) {
        .chats-header {
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 1.25rem;
        }

        .chats-header-content {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }

        .chats-header h1 {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
        }

        .stats-badge {
            padding: 0.7rem 1rem;
        }

        .stats-number {
            font-size: 1.8rem;
        }

        .chats-grid {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .chat-card {
            padding: 1rem;
            border-radius: 14px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            font-size: 1.1rem;
            border-radius: 12px;
        }

        .user-details h4 {
            font-size: 0.95rem;
        }

        .last-message {
            font-size: 0.82rem;
            padding: 0.7rem;
            margin-top: 0.7rem;
        }
    }

    /* –ë–æ–ª—å—à–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã */
    @media (max-width: 480px) {
        .chats-container {
            padding: 10px;
        }

        .chats-header {
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .chats-header h1 {
            font-size: 1.3rem;
        }

        .chats-header p {
            font-size: 0.9rem;
        }

        .stats-badge {
            padding: 0.6rem 0.9rem;
        }

        .stats-number {
            font-size: 1.6rem;
        }

        .stats-label {
            font-size: 0.75rem;
        }

        .chat-card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
        }

        .chat-status {
            flex-direction: row;
            align-items: center;
            width: 100%;
            justify-content: space-between;
        }

        .chat-user-info {
            width: 100%;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            font-size: 1rem;
        }

        .user-details h4 {
            font-size: 0.9rem;
        }

        .user-role {
            font-size: 0.75rem;
        }

        .bot-status, .manager-info {
            font-size: 0.7rem;
            padding: 0.35rem 0.6rem;
        }

        .unread-badge {
            font-size: 0.65rem;
            padding: 0.3rem 0.6rem;
        }

        .last-message-time {
            font-size: 0.7rem;
        }

        .last-message {
            font-size: 0.8rem;
            padding: 0.6rem;
            margin-top: 0.6rem;
            -webkit-line-clamp: 3;
        }

        .no-chats {
            padding: 2rem 1rem;
        }

        .no-chats-icon {
            font-size: 3.5rem;
        }

        .no-chats h3 {
            font-size: 1.2rem;
        }

        .no-chats p {
            font-size: 0.85rem;
        }
    }

    /* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã */
    @media (max-width: 360px) {
        .chats-container {
            padding: 8px;
        }

        .chats-header {
            padding: 1rem;
            border-radius: 14px;
        }

        .chats-header h1 {
            font-size: 1.2rem;
        }

        .chat-card {
            padding: 0.875rem;
            border-radius: 12px;
        }

        .user-avatar {
            width: 38px;
            height: 38px;
            font-size: 0.9rem;
        }

        .user-details h4 {
            font-size: 0.85rem;
        }

        .last-message {
            font-size: 0.78rem;
            padding: 0.5rem;
        }
    }

    /* –ü–µ–π–∑–∞–∂–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-width: 768px) and (orientation: landscape) {
        .chats-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .chats-header-content {
            flex-direction: row;
            text-align: left;
        }
    }

    /* –í—ã—Å–æ–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
    @media (min-height: 800px) and (max-width: 768px) {
        .no-chats {
            padding: 4rem 2rem;
        }
    }

    /* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ hover —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –Ω–∞ —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
    @media (hover: none) {
        .chat-card:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .chat-card:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
    }

    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∞—á-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
    .chat-card {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }

    /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (prefers-reduced-motion: reduce) {
        .chat-card,
        .unread-badge,
        .chat-card::before {
            animation: none;
            transition: none;
        }
    }

    /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
    .chats-container::-webkit-scrollbar {
        width: 6px;
    }

    .chats-container::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.05);
        border-radius: 3px;
    }

    .chats-container::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.2);
        border-radius: 3px;
    }

    .chats-container::-webkit-scrollbar-thumb:hover {
        background: rgba(0,0,0,0.3);
    }
</style>

<div class="chats-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="chats-header">
        <div class="chats-header-content d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
                <h1 class="h3 mb-2 fw-bold">
                    <i class="fas fa-comments me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏
                </h1>
                <p class="mb-0 opacity-90">–û–±—â–∞–π—Ç–µ—Å—å —Å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º–∏ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</p>
            </div>
            <div class="stats-badge flex-shrink-0">
                <div class="stats-number">{{ chats|length }}</div>
                <div class="stats-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
    {% if chats %}
    <div class="chats-grid">
        {% for chat in chats %}
        <div class="chat-card {% if chat.unread_count > 0 %}unread{% endif %} {% if chat.manager_id %}manager-assigned{% endif %}"
             data-user-id="{{ chat.user_id }}">
            <div class="chat-card-header">
                <div class="chat-user-info">
                    <div class="user-avatar">
                        {{ chat.user_name[0]|upper }}
                    </div>
                    <div class="user-details">
                        <h4>{{ chat.user_name }}</h4>
                        <div class="user-role">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</div>
                        <div class="bot-status {% if chat.bot_enabled %}bot-enabled{% else %}bot-disabled{% endif %}">
                            <i class="fas fa-robot"></i>
                            {% if chat.bot_enabled %}–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω{% else %}–ë–æ—Ç –æ—Ç–∫–ª—é—á–µ–Ω{% endif %}
                        </div>
                    </div>
                </div>
                <div class="chat-status">
                    {% if chat.unread_count > 0 %}
                    <span class="unread-badge">{{ chat.unread_count }} –Ω–æ–≤—ã—Ö</span>
                    {% endif %}
                    {% if chat.unread_count == 0 %}
                    <span class="last-message-time">
                        {{ chat.last_message_time|default('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π') }}
                    </span>
                    {% endif %}
                </div>
            </div>

            {% if chat.manager_id %}
            <div class="manager-info">
                <i class="fas fa-user-tie"></i>
                –ù–∞–∑–Ω–∞—á–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä
            </div>
            {% endif %}

            {% if chat.last_message %}
            <div class="last-message">
                <strong>
                    {% if chat.last_message.role == 'user' %}üë§{% endif %}
                    {% if chat.last_message.role == 'bot' %}ü§ñ{% endif %}
                    {% if chat.last_message.role == 'manager' %}üë®‚Äçüíº{% endif %}
                </strong>
                {{ chat.last_message.content|truncate(80) }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-chats">
        <div class="no-chats-icon">
            <i class="fas fa-comments"></i>
        </div>
        <h3>–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
        <p>–ö–æ–≥–¥–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏ –Ω–∞—á–Ω—É—Ç –æ–±—â–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π,<br>—á–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
    </div>
    {% endif %}
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let refreshInterval;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ AJAX
async function updateChatsList() {
    try {
        const response = await fetch(window.location.href);
        if (response.ok) {
            const text = await response.text();

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = text;

            // –ù–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–æ–≤
            const newChatsContainer = tempDiv.querySelector('.chats-grid') || tempDiv.querySelector('.no-chats');
            const currentChatsContainer = document.querySelector('.chats-grid') || document.querySelector('.no-chats');

            if (newChatsContainer && currentChatsContainer) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
                const scrollPosition = window.scrollY;

                // –ó–∞–º–µ–Ω—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                currentChatsContainer.replaceWith(newChatsContainer);

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
                window.scrollTo(0, scrollPosition);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
                const newStatsBadge = tempDiv.querySelector('.stats-badge');
                const currentStatsBadge = document.querySelector('.stats-badge');
                if (newStatsBadge && currentStatsBadge) {
                    currentStatsBadge.replaceWith(newStatsBadge);
                }

                // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏
                initializeChatCards();
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤:', error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–Ω–∏–º–∞—Ü–∏–π –∫–∞—Ä—Ç–æ—á–µ–∫
function initializeChatCards() {
    const chatCards = document.querySelectorAll('.chat-card');
    chatCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });
}

// –£–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
function startMobileRefresh() {
    let isUserActive = true;
    let inactivityTimer;

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function resetInactivityTimer() {
        isUserActive = true;
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
            isUserActive = false;
        }, 30000); // 30 —Å–µ–∫—É–Ω–¥ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
    const userEvents = ['touchstart', 'touchend', 'click', 'scroll', 'keydown'];
    userEvents.forEach(event => {
        document.addEventListener(event, resetInactivityTimer, { passive: true });
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function handleVisibilityChange() {
        if (document.hidden) {
            clearInterval(refreshInterval);
        } else {
            startRefreshInterval();
        }
    }

    document.addEventListener('visibilitychange', handleVisibilityChange);

    // –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ä–µ–∂–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –±–∞—Ç–∞—Ä–µ–∏)
    function startRefreshInterval() {
        clearInterval(refreshInterval);
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const interval = isMobile ? 20000 : 15000; // 20 —Å–µ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, 15 –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø

        refreshInterval = setInterval(() => {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω –∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–∏–¥–∏–º–∞
            if (!isUserActive && !document.hidden) {
                updateChatsList();
            }
        }, interval);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    resetInactivityTimer();
    startRefreshInterval();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    initializeChatCards();
    startMobileRefresh();

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        clearInterval(refreshInterval);
    });
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        updateChatsList();
    }
});

// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ç–µ–π
if ('connection' in navigator) {
    const connection = navigator.connection;
    if (connection.saveData || connection.effectiveType.includes('2g')) {
        // –†–µ–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è—Ö
        clearInterval(refreshInterval);
        refreshInterval = setInterval(updateChatsList, 30000);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ –∏ –ø–æ–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
function openChat(userId) {
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
    fetch(`/admin/api/chat/${userId}/mark_read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    }).then(response => {
        // –ó–∞—Ç–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —á–∞—Ç
        location.href = `/admin/chat/${userId}`;
    }).catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ:', error);
        // –í—Å–µ —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —á–∞—Ç
        location.href = `/admin/chat/${userId}`;
    });
}

// –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    const chatCards = document.querySelectorAll('.chat-card');
    chatCards.forEach(card => {
        const userId = card.getAttribute('data-user-id');
        if (userId) {
            card.onclick = function() { openChat(userId); };
        }
    });
});
</script>
{% endblock %}